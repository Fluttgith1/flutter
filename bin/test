#!/usr/bin/env bash
# Copyright 2014 The Flutter Authors. All rights reserved.
# Use of this source code is governed by a BSD-style license that can be
# found in the LICENSE file.

# ---------------------------------- NOTE ---------------------------------- #
#
# Please keep the logic in this file consistent with the logic in the
# `dart.bat` script in the same directory to ensure that Flutter & Dart continue
# to work across all platforms!
#
# -------------------------------------------------------------------------- #

set -e

unset CDPATH

function follow_links() {
  echo "1: $PWD" >&2
  cd -P "${1%/*}"
  echo "2: $PWD" >&2
  local file="$PWD/${1##*/}"
  echo "3: $file" >&2
  while [[ -h "$file" ]]; do
    echo "4: $file" >&2
    # On Mac OS, readlink -f doesn't work.
    cd -P "${file%/*}"
    file="$(readlink "$file")"
    cd -P "${file%/*}"
    file="$PWD/${file##*/}"
  done
  echo "5: $PWD" >&2
  echo "6: $PWD/${file##*/}" >&2
  echo "$PWD/${file##*/}"
}

# Convert a filesystem path to a format usable by Dart's URI parser.
function path_uri() {
  # Reduce multiple leading slashes to a single slash.
  #echo "$1" | sed -E -e "s,^/+,/,"
  echo "$1"
}

PROG_NAME="$(path_uri "$(follow_links "$BASH_SOURCE")")"
BIN_DIR="$(cd "${PROG_NAME%/*}" ; pwd -P)"

echo "PWD = $PWD"
echo "PROG_NAME = $PROG_NAME"
echo "BIN_DIR = $BIN_DIR"
